<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Funcleson Funkatorium Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg-main: #14151a;
      --bg-panel: #181920;
      --bg-strip: #181920;
      --accent-yellow: #f4c430;
      --accent-yellow-soft: #ffdd6a;
      --text-main: #f9fafb;
      --text-soft: #c3c6d1;
      --text-muted: #8e93a3;
      --divider: #272935;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
    }

    body {
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 8px 16px;
    }

    .board {
      width: 100%;
      max-width: 1920px;
      height: 100%;
      max-height: 1080px;
      display: flex;
      flex-direction: column;
      background: var(--bg-main);
      border-radius: 8px;
      border: 1px solid #20222c;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
      overflow: hidden;
    }

    /* === HEADER === */
    .board-header {
      flex: 0 0 auto;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #101119;
      border-bottom: 1px solid var(--divider);
    }

    .venue-name {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent-yellow-soft);
    }

    .header-right {
      display: flex;
      align-items: baseline;
      gap: 18px;
    }

    .section-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
    }

    .small-timestamp {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* === MAIN MENU AREA === */
    .board-main {
      flex: 1 1 auto;
      display: flex;
      gap: 16px;
      padding: 14px 20px 10px 20px;
      background: radial-gradient(circle at top, #1e202b 0%, #13151e 50%, #101119 100%);
    }

    .menu-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .beer-row {
      display: flex;
      flex-direction: column;
      padding: 6px 10px;
      border-radius: 4px;
      background: rgba(24, 25, 32, 0.9);
      border: 1px solid rgba(39, 41, 53, 0.9);
    }

    .beer-top {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .beer-name {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--text-main);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .beer-meta-inline {
      font-size: 0.8rem;
      color: var(--text-soft);
      white-space: nowrap;
      opacity: 0.95;
    }

    .beer-bottom {
      margin-top: 2px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .beer-style {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .beer-price {
      font-weight: 600;
      color: var(--accent-yellow-soft);
      white-space: nowrap;
    }

    .tap-badge {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid rgba(244, 196, 48, 0.85);
      color: var(--accent-yellow-soft);
    }

    .featured-tag {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid rgba(144, 205, 244, 0.8);
      color: #9cd0ff;
      margin-left: 6px;
    }

    /* === FOOTER TICKER === */
    .board-footer {
      flex: 0 0 auto;
      padding: 8px 18px 10px 18px;
      background: #101119;
      border-top: 1px solid var(--divider);
    }

    .ticker-shell {
      width: 100%;
      background: var(--bg-strip);
      border-radius: 6px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      border: 1px solid #20222c;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.45);
    }

    .ticker-label {
      flex-shrink: 0;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(244, 196, 48, 0.9);
      background: rgba(244, 196, 48, 0.12);
      font-size: 0.7rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--accent-yellow-soft);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .ticker-label-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-yellow);
    }

    .ticker-window {
      flex: 1;
      overflow: hidden;
      position: relative;
      height: 34px;
    }

    .ticker-track {
      position: absolute;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      will-change: transform;
      animation: scroll 45s linear infinite; /* adjust speed here */
    }

    .ticker-content {
      display: inline-flex;
      align-items: center;
      gap: 1.8rem;
      font-size: 0.98rem;
      color: var(--text-main);
    }

    .ticker-item {
      display: inline-flex;
      align-items: baseline;
      gap: 0.35rem;
    }

    .ticker-user {
      font-weight: 600;
      color: var(--accent-yellow);
    }

    .ticker-beer {
      font-weight: 600;
      color: var(--text-main);
    }

    .ticker-time {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .ticker-separator {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .ticker-empty {
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .status-pill {
      flex-shrink: 0;
      font-size: 0.78rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    @keyframes scroll {
      from {
        transform: translateX(0);
      }
      to {
        transform: translateX(-50%);
      }
    }

    @media (max-width: 900px) {
      .board {
        max-height: none;
      }

      .board-main {
        flex-direction: column;
      }

      .menu-column {
        width: 100%;
      }

      .ticker-label {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="board">
    <header class="board-header">
      <div class="venue-name">Funcleson Funkatorium</div>
      <div class="header-right">
        <span class="section-label">On Tap</span>
        <span class="small-timestamp" id="boardUpdated"></span>
      </div>
    </header>

    <main class="board-main">
      <div class="menu-column" id="menuColumnLeft"></div>
      <div class="menu-column" id="menuColumnRight"></div>
    </main>

    <footer class="board-footer">
      <div class="ticker-shell">
        <div class="ticker-label">
          <span class="ticker-label-dot"></span>
          <span>Live Check-ins</span>
        </div>

        <div class="ticker-window">
          <div class="ticker-track" id="tickerTrack">
            <div class="ticker-content" id="tickerContent">
              <span class="ticker-empty">
                Waiting for check-ins… open Untappd and log a beer at this venue.
              </span>
            </div>
          </div>
        </div>

        <div class="status-pill" id="statusText">
          Updating…
        </div>
      </div>
    </footer>
  </div>

  <script>
    // ========= TAP LIST CONFIG (EDIT THIS SECTION) =========
    // Add/remove beers here. The screen auto-splits into 2 columns.
    const BEERS = [
const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8XJ2EmSMTcR_XrbIegnEEZvGCmix6h9EnEgQi-QwUpIM0JQ0GkdtbiD1X5V29gdG_S81hKd3Eh6QA/pub?output=csv";

// Empty array – will be filled from Google Sheets.
let BEERS = [];

async function fetchBeersFromSheet() {
  try {
    const res = await fetch(GOOGLE_SHEET_CSV_URL);
    const text = await res.text();

    BEERS = parseCSV(text);
    buildMenu();
  } catch (e) {
    console.error("Error loading beer sheet:", e);
  }
}
    ];

    // ========= TICKER CONFIG =========
    const VENUE_RSS_URL = "https://untappd.com/rss/venue/9899874";
    const REFRESH_MS = 60000; // 60s
    const MAX_AGE_HOURS = 7000;

    const tickerTrack = document.getElementById("tickerTrack");
    const tickerContent = document.getElementById("tickerContent");
    const statusText = document.getElementById("statusText");
    const boardUpdated = document.getElementById("boardUpdated");

    // ========= HELPERS =========
    function timeAgo(dateString) {
      const then = new Date(dateString);
      if (isNaN(then)) return "";
      const now = new Date();
      const diffMs = now - then;
      const minutes = Math.floor(diffMs / 60000);
      const hours = Math.floor(minutes / 60);

      if (minutes < 1) return "just now";
      if (minutes < 60) return `${minutes} min ago`;
      if (hours < 24) return `${hours} hr${hours !== 1 ? "s" : ""} ago`;
      const days = Math.floor(hours / 24);
      return `${days} day${days !== 1 ? "s" : ""} ago`;
    }

    function isRecentEnough(dateString) {
      const then = new Date(dateString);
      if (isNaN(then)) return false;
      const now = new Date();
      const diffMs = now - then;
      const hours = diffMs / (1000 * 60 * 60);
      return hours <= MAX_AGE_HOURS;
    }

    function cleanBeerName(name) {
      if (!name) return "";
      return name.replace(/^(a |an )/i, "").trim();
    }

    function parseRating(item) {
      const raw = (item.description || "") + " " + (item.content || "");
      const text = raw.replace(/<[^>]+>/g, " ");

      let match = text.match(/\(([0-9.]+)\s*\/\s*5/i);
      if (match) return match[1];

      match = text.match(/([0-9.]+)\s*\/\s*5/i);
      if (match) return match[1];

      match = text.match(/Rating:\s*([0-9.]+)/i);
      if (match) return match[1];

      return "";
    }

    function parseUntappdTitle(title) {
      let user = "";
      let beer = "";
      let brewery = "";

      if (!title) return { user, beer, brewery };

      let base = title;
      const atIndex = base.toLowerCase().lastIndexOf(" at ");
      if (atIndex !== -1) base = base.slice(0, atIndex);

      let parts = base.split(" is drinking ");
      if (parts.length === 1) parts = base.split(" drank ");

      let rest = "";
      if (parts.length > 1) {
        user = parts[0].trim();
        rest = parts[1].trim();
      } else {
        rest = base.trim();
      }

      let beerCandidate = rest;
      let breweryCandidate = "";

      const bySplit = rest.split(" by ");
      if (bySplit.length > 1) {
        beerCandidate = bySplit[0].trim();
        breweryCandidate = bySplit.slice(1).join(" by ").trim();
      }

      if (!breweryCandidate) {
        const parenMatch = beerCandidate.match(/\(([^)]+)\)\s*$/);
        if (parenMatch) {
          breweryCandidate = parenMatch[1].trim();
          beerCandidate = beerCandidate.replace(/\s*\([^)]+\)\s*$/, "").trim();
        }
      }

      beer = beerCandidate;
      brewery = breweryCandidate;

      return { user, beer, brewery };
    }

    function addSeparator(parent) {
      const dot = document.createElement("span");
      dot.className = "ticker-separator";
      dot.textContent = "·";
      parent.appendChild(dot);
    }

    // ========= BUILD MENU =========
    function buildMenu() {
      const leftCol = document.getElementById("menuColumnLeft");
      const rightCol = document.getElementById("menuColumnRight");
      leftCol.innerHTML = "";
      rightCol.innerHTML = "";

      const beers = [...BEERS];
      // simple split into two columns
      const mid = Math.ceil(beers.length / 2);
      const leftBeers = beers.slice(0, mid);
      const rightBeers = beers.slice(mid);

      function renderColumn(list, container) {
        list.forEach((beer) => {
          const row = document.createElement("div");
          row.className = "beer-row";

          const top = document.createElement("div");
          top.className = "beer-top";

          const name = document.createElement("div");
          name.className = "beer-name";
          name.textContent = beer.name;

          const metaInline = document.createElement("div");
          metaInline.className = "beer-meta-inline";

          const bits = [];
          if (beer.abv) bits.push(beer.abv);
          if (beer.ibu) bits.push(beer.ibu);
          if (beer.pour) bits.push(beer.pour);
          metaInline.textContent = bits.join(" · ");

          top.appendChild(name);

          const rightMeta = document.createElement("div");
          rightMeta.style.display = "flex";
          rightMeta.style.alignItems = "center";
          rightMeta.style.gap = "6px";

          if (beer.tap) {
            const tap = document.createElement("span");
            tap.className = "tap-badge";
            tap.textContent = `Tap ${beer.tap}`;
            rightMeta.appendChild(tap);
          }

          if (beer.featured) {
            const feat = document.createElement("span");
            feat.className = "featured-tag";
            feat.textContent = "Featured";
            rightMeta.appendChild(feat);
          }

          top.appendChild(rightMeta);

          const bottom = document.createElement("div");
          bottom.className = "beer-bottom";

          const style = document.createElement("div");
          style.className = "beer-style";
          style.textContent = beer.style || beer.brewery || "";

          const price = document.createElement("div");
          price.className = "beer-price";
          price.textContent = beer.price || "";

          bottom.appendChild(style);
          bottom.appendChild(price);

          row.appendChild(top);
          if (bits.length) row.appendChild(metaInline);
          row.appendChild(bottom);

          container.appendChild(row);
        });
      }

      renderColumn(leftBeers, leftCol);
      renderColumn(rightBeers, rightCol);

      if (boardUpdated) {
        const now = new Date();
        boardUpdated.textContent = "Updated " + now.toLocaleTimeString();
      }
    }

    // ========= BUILD TICKER =========
    function buildTicker(items) {
      tickerContent.innerHTML = "";

      if (!items || !items.length) {
        const span = document.createElement("span");
        span.className = "ticker-empty";
        span.textContent = "No recent check-ins.";
        tickerContent.appendChild(span);
        return;
      }

      const recentItems = items.filter((item) => isRecentEnough(item.pubDate));

      if (!recentItems.length) {
        const span = document.createElement("span");
        span.className = "ticker-empty";
        span.textContent = "No check-ins in the selected time window.";
        tickerContent.appendChild(span);
        return;
      }

      const maxItems = Math.min(recentItems.length, 10);

      for (let i = 0; i < maxItems; i++) {
        const item = recentItems[i];
        const { user, beer, brewery } = parseUntappdTitle(item.title);

        const cleanBeer = cleanBeerName(beer);
        const rating = parseRating(item);
        const time = timeAgo(item.pubDate);

        const itemEl = document.createElement("span");
        itemEl.className = "ticker-item";

        const userEl = document.createElement("span");
        userEl.className = "ticker-user";
        userEl.textContent = user || "Someone";

        const beerEl = document.createElement("span");
        beerEl.className = "ticker-beer";
        if (cleanBeer && brewery) {
          beerEl.textContent = `${cleanBeer} by ${brewery}`;
        } else if (cleanBeer) {
          beerEl.textContent = cleanBeer;
        } else {
          beerEl.textContent = "A beer";
        }

        const ratingEl = document.createElement("span");
        ratingEl.className = "ticker-beer";
        ratingEl.textContent = rating ? `Rated ${rating}/5` : "";

        const timeEl = document.createElement("span");
        timeEl.className = "ticker-time";
        timeEl.textContent = time || "";

        itemEl.appendChild(userEl);

        if (cleanBeer) {
          addSeparator(itemEl);
          itemEl.appendChild(beerEl);
        }

        if (rating) {
          addSeparator(itemEl);
          itemEl.appendChild(ratingEl);
        }

        if (time) {
          addSeparator(itemEl);
          itemEl.appendChild(timeEl);
        }

        tickerContent.appendChild(itemEl);

        if (i < maxItems - 1) {
          const sep = document.createElement("span");
          sep.className = "ticker-separator";
          sep.textContent = "·";
          tickerContent.appendChild(sep);
        }
      }

      const clone = tickerContent.cloneNode(true);
      tickerTrack.innerHTML = "";
      tickerTrack.appendChild(tickerContent);
      tickerTrack.appendChild(clone);
    }

    async function fetchCheckins() {
      try {
        statusText.textContent = "Updating…";

        const rssUrl = encodeURIComponent(VENUE_RSS_URL);
        const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${rssUrl}`;

        const res = await fetch(apiUrl);
        if (!res.ok) {
          statusText.textContent = "Feed error";
          return;
        }

        const data = await res.json();
        const items = data.items || [];

        buildTicker(items);

        statusText.textContent = "Last updated " + new Date().toLocaleTimeString();
      } catch (err) {
        console.error(err);
        statusText.textContent = "Network error";
      }
    }

    function startAutoRefresh() {
      fetchCheckins();
      setInterval(fetchCheckins, REFRESH_MS);
    }

    document.addEventListener("DOMContentLoaded", () => {
      buildMenu();
      startAutoRefresh();
    });
  </script>
</body>
</html>
